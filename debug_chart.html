<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Debug Chart Data</title>
</head>
<body>
  <h1>Debug Chart Data</h1>
  <div id="results"></div>
  
  <script>
    // Function to parse CSV data with robust quoted field handling
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      // Clean headers and remove any carriage returns
      const headers = lines[0].split(',').map(h => h.trim().replace(/\r/g, ''));
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].replace(/\r/g, ''); // Remove carriage returns
        
        // Use a proper CSV parsing approach
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          
          if (char === '"') {
            inQuotes = !inQuotes;
            // Don't add the quote character to the value
          } else if (char === ',' && !inQuotes) {
            // Found a field separator
            values.push(current.trim());
            current = '';
          } else {
            // Regular character, add to current field
            current += char;
          }
        }
        
        // Add the last field
        values.push(current.trim());
        
        // Only add rows that have the correct number of columns and aren't empty
        if (values.length === headers.length && values.some(v => v.length > 0)) {
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index];
          });
          data.push(row);
        }
      }
      
      return data;
    }

    // Function to simulate what createTimelinePlot would do
    function debugTimelineData(examData) {
      if (examData.length === 0) {
        return { error: "No exams found" };
      }

      // Sort by date to ensure proper chronological order
      examData.sort((a, b) => new Date(a['Exam Date']) - new Date(b['Exam Date']));
      
      const dates = examData.map(exam => exam['Exam Date']);
      const titles = examData.map(exam => exam['Exam Title']);
      const examNumbers = examData.map(exam => exam['Exam Number']);

      return {
        totalExams: examData.length,
        dates: dates,
        titles: titles,
        examNumbers: examNumbers,
        firstExam: examData[0],
        lastExam: examData[examData.length - 1]
      };
    }

    // Load and process CSV data
    async function loadAndDebugExamData() {
      try {
        const response = await fetch('passed_exams.csv');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const allExamData = parseCSV(csvText);
        
        const debugData = debugTimelineData(allExamData);
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
          <h2>Debug Results</h2>
          <p><strong>Total exams parsed:</strong> ${debugData.totalExams}</p>
          <p><strong>Dates array length:</strong> ${debugData.dates.length}</p>
          <p><strong>Titles array length:</strong> ${debugData.titles.length}</p>
          <p><strong>Exam numbers array length:</strong> ${debugData.examNumbers.length}</p>
          
          <h3>First 10 titles that would be sent to chart:</h3>
          <ul>
            ${debugData.titles.slice(0, 10).map((title, i) => `<li>${i+1}. ${title} (${debugData.examNumbers[i]}) - ${debugData.dates[i]}</li>`).join('')}
          </ul>
          
          <h3>Last 10 titles that would be sent to chart:</h3>
          <ul>
            ${debugData.titles.slice(-10).map((title, i) => {
              const actualIndex = debugData.titles.length - 10 + i;
              return `<li>${actualIndex+1}. ${title} (${debugData.examNumbers[actualIndex]}) - ${debugData.dates[actualIndex]}</li>`;
            }).join('')}
          </ul>
          
          <h3>All exam titles (Y-axis values):</h3>
          <ol>
            ${debugData.titles.map((title, i) => `<li>${title} (${debugData.examNumbers[i]}) - ${debugData.dates[i]}</li>`).join('')}
          </ol>
        `;
        
      } catch (error) {
        console.error('Error loading exam data:', error);
        document.getElementById('results').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadAndDebugExamData);
  </script>
</body>
</html>